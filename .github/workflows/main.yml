permissions:
  id-token: write
  contents: read
on: [push,workflow_dispatch]
jobs:
  BUILD-CUSTOM-UBUNTU-IMAGE:
    # runs-on: ubuntu-latest    
    runs-on: ubuntu-latest
    environment: prd
    steps:
    # # [FAILED] Use userAssignedIdentity to login to Azure
    # - name: AZURE LOGIN 
    #   uses: Azure/login@v1.5.1
    #   with:
    #     auth-type: IDENTITY
    #     client-id: ${{ secrets.AZURE_CLIENT_ID }}
    #     tenant-id: ${{ secrets.AZURE_TENANT_ID }}
    #     subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    #     enable-AzPSSession: true
    - name: Azure CLI script
      uses: azure/CLI@v1
      with:
        azcliversion: latest
        inlineScript: |
          az version
    - name: AZURE LOGIN 
      uses: azure/login@v1
      with:
        auth-type: IDENTITY
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: true
    - name: Azure CLI script
      uses: azure/CLI@v1
      with:
        azcliversion: latest
        inlineScript: |
          az account show
    - name: BUILD-CUSTOM-VM-IMAGE      
      uses: azure/build-vm-image@v0
      with:        
        resource-group-name: 'myResourceGroup'
        managed-identity: 'myImageBuilderIdentity'
        location: 'eastus2'
        source-os-type: 'linux'        
        # source-image: Canonical:UbuntuServer:18.04-LTS:latest
        source-image: Canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest
        customizer-source: /vhd-build/init.sh
        customizer-script: |
          sh /vhd-build/init.sh
        dist-type: 'SharedImageGallery'
        dist-resource-id: ''
        dist-location: 'eastus2'
          
        
